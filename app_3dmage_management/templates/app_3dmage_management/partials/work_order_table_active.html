{% load static l10n %}
<div id="active-projects-container" 
     hx-get="{% url 'project_dashboard' %}?view=active&v={{ server_version }}&q={{ search_query|urlencode }}&status={{ status_filter|urlencode }}&category={{ category_filter|urlencode }}" 
     hx-trigger="every 10s" 
     hx-swap="outerHTML"
     hx-indicator="#loading-overlay">
    
    <div class="d-flex justify-content-end align-items-center mt-3 mb-3">
        <div class="d-flex align-items-center gap-2">
            <span class="btn btn-sm btn-secondary" style="cursor: default; pointer-events: none;">
                Totale: <strong>{{ active_count }}</strong>
            </span>
            <span class="btn btn-sm btn-primary-custom" style="cursor: default; pointer-events: none;">
                Da Stampare: <strong>{{ todo_count }}</strong>
            </span>
            <a class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" href="#activeFiltersCollapse"
                role="button" aria-expanded="false" aria-controls="activeFiltersCollapse">
                <i class="bi bi-funnel-fill me-1"></i> Filtra
            </a>
        </div>
    </div>

    <div class="card bg-dark-card mt-3">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr>
                            <th><a href="?view=active&sort_active=name&order_active={% if sort_active == 'name' and order_active == 'asc' %}desc{% else %}asc{% endif %}&q={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}">Nome Ordine {% if sort_active == 'name' %}<i class="bi bi-caret-{% if order_active == 'asc' %}up{% else %}down{% endif %}-fill"></i>{% endif %}</a></th>
                            <th class="text-center"><a href="?view=active&sort_active=priority&order_active={% if sort_active == 'priority' and order_active == 'asc' %}desc{% else %}asc{% endif %}&q={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}">Priorit√† {% if sort_active == 'priority' %}<i class="bi bi-caret-{% if order_active == 'asc' %}up{% else %}down{% endif %}-fill"></i>{% endif %}</a></th>
                            <th class="text-center"><a href="?view=active&sort_active=status&order_active={% if sort_active == 'status' and order_active == 'asc' %}desc{% else %}asc{% endif %}&q={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}">Status {% if sort_active == 'status' %}<i class="bi bi-caret-{% if order_active == 'asc' %}up{% else %}down{% endif %}-fill"></i>{% endif %}</a></th>
                            <th class="text-center">Tempo Rimanente</th>
                            <th class="text-center" style="color: var(--primary-color);"><a href="?view=active&sort_active=progress&order_active={% if sort_active == 'progress' and order_active == 'asc' %}desc{% else %}asc{% endif %}&q={{ search_query }}&status={{ status_filter }}&category={{ category_filter }}" style="color: var(--primary-color);">Progresso {% if sort_active == 'progress' %}<i class="bi bi-caret-{% if order_active == 'asc' %}up{% else %}down{% endif %}-fill"></i>{% endif %}</a></th>
                            <th class="text-center">Tempo Totale</th>
                            <th class="text-center">Categoria</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in active_projects %}
                        <tr class="clickable-row {% if project.is_locked %}row-locked{% endif %}" 
                            data-url="{% url 'project_detail' project.id %}?from=active"
                            style="cursor: pointer;">
                            <td class="fw-bold">
                                {{ project.name }}
                                {% if project.is_locked %}
                                <i class="bi bi-lock-fill text-warning ms-2" title="In modifica da {{ project.locked_by.username }}"></i>
                                {% endif %}
                            </td>
                            <td class="text-center"><span class="badge bg-priority-{{ project.priority|lower }}">{{ project.get_priority_display }}</span></td>
                            <td class="text-center"><span class="badge bg-status-{{ project.status|lower }}">{{ project.get_status_display }}</span></td>
                            <td class="text-center">{{ project.remaining_print_time }}</td>
                            <td style="position: relative; min-width: 120px;">
                                <div class="progress" style="height: 22px; background-color: #444;">
                                    {% localize off %}
                                    <div class="progress-bar" role="progressbar"
                                     style="--p: {{ project.progress_percentage }}%; width: var(--p); background-color: #ffa500 !important;">
                                    </div>
                                    {% endlocalize %}
                                </div><strong
                                    class="justify-content-center align-items-center d-flex position-absolute w-100 h-100 top-0 start-0 {% if project.progress_percentage == 0 %}text-white{% else %}text-dark{% endif %}"
                                    style="font-size: 0.8em;">{{ project.progress }}</strong>
                            </td>
                            <td class="text-center">{{ project.total_print_time }}</td>
                            <td class="text-center">{{ project.category.name|default:"N/A" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <p class="lead">Nessun ordine attivo trovato.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
